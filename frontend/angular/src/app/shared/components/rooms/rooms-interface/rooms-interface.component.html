<div class="w-full h-full pt-2 md:pt-6">
  <div class="flex flex-col h-full relative font-sans bg-gray-50 rounded-lg md:rounded-xl shadow-md md:shadow-lg p-2 md:p-4 overflow-hidden">
    
    <!-- Responsive title bar -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 md:mb-4 px-1">
      <div>
        <h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800">RESIDENCIA DE TIPO CONCERTADA (Mokkup)</h2>
        <p class="text-xs sm:text-sm text-gray-500"> -- PLANTA {{ currentFloor }} · PROYECTO: CareLink By Nexora -- </p>
      </div>

            <!-- Selector de plantas -->
          <div class="flex mb-4 bg-white rounded-lg shadow-sm p-1">
            <button *ngFor="let floor of floors" 
                    class="flex-1 px-3 py-2 rounded-md text-sm font-medium transition-all duration-300"
                    [class.bg-blue-500]="floor.id === currentFloor"
                    [class.text-white]="floor.id === currentFloor"
                    [class.text-gray-600]="floor.id !== currentFloor"
                    [class.hover:bg-blue-100]="floor.id !== currentFloor"
                    (click)="changeFloor(floor.id)">
              <div class="flex items-center justify-center">
                <i class="fa-solid fa-building-user mr-2"></i>
                <span>{{ floor.name }}</span>
              </div>
            </button>
          </div>
      
      <div class="flex gap-2 mt-2 sm:mt-0 self-start">
        <button class="bg-white border border-gray-200 rounded-md w-8 h-8 sm:w-9 sm:h-9 flex items-center justify-center cursor-pointer shadow-sm transition-all hover:bg-gray-50 hover:shadow-md text-gray-600" (click)="zoom(1.1, 400, 300)" aria-label="Acercar">
          <i class="fa-solid fa-plus text-xs sm:text-sm"></i>
        </button>
        <button class="bg-white border border-gray-200 rounded-md w-8 h-8 sm:w-9 sm:h-9 flex items-center justify-center cursor-pointer shadow-sm transition-all hover:bg-gray-50 hover:shadow-md text-gray-600" (click)="zoom(0.9, 400, 300)" aria-label="Alejar">
          <i class="fa-solid fa-minus text-xs sm:text-sm"></i>
        </button>
        <button class="bg-white border border-gray-200 rounded-md px-2 sm:px-3 h-8 sm:h-9 flex items-center justify-center cursor-pointer shadow-sm transition-all hover:bg-gray-50 hover:shadow-md text-gray-600 text-xs font-medium" (click)="resetView()">
          <i class="fa-solid fa-arrows-to-dot me-1 sm:me-2"></i> <span class="hidden xs:inline">Vista Completa</span>
        </button>
      </div>
    </div>

    
    
    <!-- Contenedor del mapa mejorado con mejor adaptación -->
    <div class="flex-1 overflow-hidden relative bg-white border border-gray-200 rounded-lg shadow-sm transition-all hover:shadow-md">
      <!-- Overlay info para dispositivos pequeños -->
      <div class="absolute top-0 left-0 right-0 z-20 bg-gray-800 bg-opacity-70 text-white text-xs py-1 px-2 text-center md:hidden">
        Use los dedos para mover y hacer zoom
      </div>
      
      <svg #mapSvg width="100%" height="100%" viewBox="0 0 1000 500" preserveAspectRatio="xMidYMid meet" 
          class="w-full h-full min-h-[250px] xs:min-h-[300px] sm:min-h-[350px] md:min-h-[450px] cursor-grab active:cursor-grabbing touch-manipulation" 
          (click)="onMapBackgroundClick()">
        <!-- Definiciones de gradientes mejorados -->
        <defs>
          <pattern id="pattern-grid" width="50" height="50" patternUnits="userSpaceOnUse">
            <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#f1f5f9" stroke-width="0.5"/>
            <path d="M 10 0 L 10 50 M 20 0 L 20 50 M 30 0 L 30 50 M 40 0 L 40 50" fill="none" stroke="#f8fafc" stroke-width="0.3"/>
            <path d="M 0 10 L 50 10 M 0 20 L 50 20 M 0 30 L 50 30 M 0 40 L 50 40" fill="none" stroke="#f8fafc" stroke-width="0.3"/>
          </pattern>
          
          <!-- Gradientes optimizados para mejor contraste -->
          <linearGradient id="gradient-room" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fff7ed" />
            <stop offset="100%" stop-color="#ffedd5" />
          </linearGradient>
          
          <linearGradient id="gradient-common" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#f9f5ff" />
            <stop offset="100%" stop-color="#f3e8ff" />
          </linearGradient>
          
          <linearGradient id="gradient-kitchen" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#ecfeff" />
            <stop offset="100%" stop-color="#e0f2fe" />
          </linearGradient>
          
          <linearGradient id="gradient-bath" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#eff6ff" />
            <stop offset="100%" stop-color="#dbeafe" />
          </linearGradient>
          
          <linearGradient id="gradient-laundry" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fffbeb" />
            <stop offset="100%" stop-color="#fef3c7" />
          </linearGradient>
          
          <linearGradient id="gradient-dining" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#f0fdf4" />
            <stop offset="100%" stop-color="#dcfce7" />
          </linearGradient>
          
          <linearGradient id="gradient-reception" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fdf2f8" />
            <stop offset="100%" stop-color="#fbcfe8" />
          </linearGradient>
          
          <linearGradient id="gradient-office" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#eff6ff" />
            <stop offset="100%" stop-color="#bfdbfe" />
          </linearGradient>
          
          <linearGradient id="gradient-gym" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fffbeb" />
            <stop offset="100%" stop-color="#fcd34d" />
          </linearGradient>
          
          <linearGradient id="gradient-multiroom" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#f5f3ff" />
            <stop offset="100%" stop-color="#ddd6fe" />
          </linearGradient>

          <linearGradient id="gradient-garden" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#ecfdf5" />
            <stop offset="100%" stop-color="#a7f3d0" />
          </linearGradient>

          <linearGradient id="gradient-memory" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#eff6ff" />
            <stop offset="100%" stop-color="#bfdbfe" />
          </linearGradient>

          <linearGradient id="gradient-special" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fef9c3" />
            <stop offset="100%" stop-color="#fef08a" />
          </linearGradient>

          <linearGradient id="gradient-nurse" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fee2e2" />
            <stop offset="100%" stop-color="#fecaca" />
          </linearGradient>

          <linearGradient id="gradient-medical" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#dcfce7" />
            <stop offset="100%" stop-color="#bbf7d0" />
          </linearGradient>

          <linearGradient id="gradient-sensory" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#f5f3ff" />
            <stop offset="100%" stop-color="#e9d5ff" />
          </linearGradient>

          <linearGradient id="gradient-monitor" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fce7f3" />
            <stop offset="100%" stop-color="#fbcfe8" />
          </linearGradient>

          <linearGradient id="gradient-secure-garden" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#d1fae5" />
            <stop offset="100%" stop-color="#86efac" />
          </linearGradient>

          <linearGradient id="gradient-staff-night" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#ede9fe" />
            <stop offset="100%" stop-color="#c4b5fd" />
          </linearGradient>

          <linearGradient id="gradient-family-room" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fae8ff" />
            <stop offset="100%" stop-color="#e879f9" stop-opacity="0.5" />
          </linearGradient>

          <linearGradient id="gradient-isolation" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#fee2e2" />
            <stop offset="100%" stop-color="#fca5a5" />
          </linearGradient>

          <linearGradient id="gradient-library" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#e0f2fe" />
            <stop offset="100%" stop-color="#93c5fd" />
          </linearGradient>

          <linearGradient id="gradient-staff-room" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#f3f4f6" />
            <stop offset="100%" stop-color="#d1d5db" />
          </linearGradient>

          <linearGradient id="gradient-storage" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#f5f5f4" />
            <stop offset="100%" stop-color="#d6d3d1" />
          </linearGradient>

          <!-- Marcador de flecha optimizado -->
          <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="0" refY="3" orient="auto">
            <polygon points="0 0, 6 3, 0 6" fill="#3b82f6" />
          </marker>
          
          <!-- Filtros para sombras más eficientes -->
          <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="1.5" dy="1.5" stdDeviation="1.5" flood-color="#64748b" flood-opacity="0.15"/>
          </filter>
          
          <!-- Filtro para hover en móvil -->
          <filter id="hoverEffect" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="1" stdDeviation="3" flood-color="#3b82f6" flood-opacity="0.3"/>
          </filter>
        </defs>
        
        <g class="map-content">
          <!-- Fondo del mapa con patrón de cuadrícula -->
          <rect width="1000" height="500" fill="white"></rect>
          <rect width="1000" height="500" fill="url(#pattern-grid)"></rect>
          
          <!-- Marco del edificio con sombra elegante -->
          <rect x="50" y="50" width="900" height="400" fill="white" stroke="#64748b" stroke-width="2" filter="url(#dropShadow)" rx="4" ry="4"></rect>
          
          <!-- Pasillos horizontales -->
          <rect x="60" y="160" width="880" height="30" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1" rx="2" ry="2"></rect>
          <rect x="60" y="310" width="880" height="30" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1" rx="2" ry="2"></rect>
          
          <!-- Pasillo vertical -->
          <rect x="500" y="190" width="30" height="120" fill="#f8fafc" stroke="#cbd5e1" stroke-width="1" rx="2" ry="2"></rect>
          
          <!-- HABITACIONES GENERADAS DINÁMICAMENTE con efectos mejorados -->
          <ng-container *ngFor="let room of rooms">
            <!-- Rectángulo de la habitación con efectos mejorados -->
            <rect 
              [attr.id]="room.id" 
              [attr.x]="getRoomCoords(room).x"
              [attr.y]="getRoomCoords(room).y"
              [attr.width]="getRoomCoords(room).width"
              [attr.height]="getRoomCoords(room).height"
              [attr.fill]="getRoomFill(room.id)"
              [attr.stroke]="getRoomStroke(room.id)"
              stroke-width="1.5"
              rx="3" ry="3"
              class="room-rect transition-all duration-200 cursor-pointer hover:stroke-[2.5px]"
              filter="drop-shadow(0px 1px 1px rgba(0,0,0,0.05))"
              (click)="openDetailsModal(room)">
            </rect>
            
            <!-- Puertas para las habitaciones con mejor visibilidad -->
            <line 
              *ngIf="room.id.startsWith('h1') || room.id === 'commonRoom' || room.id === 'bathNorth'" 
              [attr.x1]="getRoomCenter(room).x - 10"
              [attr.y1]="getRoomCoords(room).y + getRoomCoords(room).height" 
              [attr.x2]="getRoomCenter(room).x + 10"
              [attr.y2]="getRoomCoords(room).y + getRoomCoords(room).height" 
              stroke="#475569" 
              stroke-width="2.5"
              stroke-linecap="round">
            </line>
            
            <line 
              *ngIf="room.id.startsWith('h2') || room.id === 'laundry' || room.id === 'bathSouth'" 
              [attr.x1]="getRoomCenter(room).x - 10"
              [attr.y1]="getRoomCoords(room).y" 
              [attr.x2]="getRoomCenter(room).x + 10"
              [attr.y2]="getRoomCoords(room).y" 
              stroke="#475569" 
              stroke-width="2.5"
              stroke-linecap="round">
            </line>
            
            <line 
              *ngIf="room.id === 'kitchen'" 
              [attr.x1]="getRoomCoords(room).x" 
              [attr.y1]="getRoomCenter(room).y - 10"
              [attr.x2]="getRoomCoords(room).x"
              [attr.y2]="getRoomCenter(room).y + 10" 
              stroke="#475569" 
              stroke-width="2.5"
              stroke-linecap="round">
            </line>
            <line 
              *ngIf="room.id === 'dining'" 
              [attr.x1]="getRoomCoords(room).x + getRoomCoords(room).width" 
              [attr.y1]="getRoomCenter(room).y - 10"
              [attr.x2]="getRoomCoords(room).x + getRoomCoords(room).width"
              [attr.y2]="getRoomCenter(room).y + 10" 
              stroke="#475569" 
              stroke-width="2.5"
              stroke-linecap="round">
            </line>
            
            
            <!-- Puertas para las nuevas habitaciones -->
            <line 
              *ngIf="room.id === 'reception' || room.id === 'office'" 
              [attr.x1]="getRoomCenter(room).x - 10"
              [attr.y1]="getRoomCoords(room).y + getRoomCoords(room).height" 
              [attr.x2]="getRoomCenter(room).x + 10"
              [attr.y2]="getRoomCoords(room).y + getRoomCoords(room).height" 
              stroke="#475569" 
              stroke-width="2.5"
              stroke-linecap="round">
            </line>
            
            <line 
              *ngIf="room.id === 'gym' || room.id === 'multiroom'" 
              [attr.x1]="getRoomCenter(room).x - 10"
              [attr.y1]="getRoomCoords(room).y" 
              [attr.x2]="getRoomCenter(room).x + 10"
              [attr.y2]="getRoomCoords(room).y" 
              stroke="#475569" 
              stroke-width="2.5"
              stroke-linecap="round">
            </line>

            <line 
              *ngIf="room.id === 'garden'" 
              [attr.x1]="getRoomCoords(room).x" 
              [attr.y1]="getRoomCenter(room).y - 10"
              [attr.x2]="getRoomCoords(room).x"
              [attr.y2]="getRoomCenter(room).y + 10" 
              stroke="#475569" 
              stroke-width="2.5"
              stroke-linecap="round">
            </line>
            
            <!-- Nombres de habitación con mejor visibilidad -->
            <text 
              [attr.x]="getRoomCenter(room).x"
              [attr.y]="(room.id === 'reception' || room.id === 'office' || room.id === 'gym' || room.id === 'multiroom') ? 
                getRoomCenter(room).y + 8 : 
                (room.id.includes('bath') || room.id === 'laundry' ? 
                  getRoomCenter(room).y + 10 : getRoomCenter(room).y + 22)"
              text-anchor="middle" 
              class="room-text text-xs sm:text-sm font-semibold select-none pointer-events-none"
              fill="#374151">
              {{room.name}}
            </text>

              <!-- Icono Font Awesome -->
            <foreignObject 
              [attr.x]="getRoomCenter(room).x - 8" 
              [attr.y]="getRoomCenter(room).y - 15" 
              width="16" 
              height="16" 
              style="pointer-events: none;">
              <xhtml:div xmlns="http://www.w3.org/1999/xhtml" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                <i [class]="getRoomIcon(room.id)" style="font-size: 12px; color: #475569;"></i>
              </xhtml:div>
            </foreignObject>
            
            <!-- Ventanas para habitaciones exteriores con estilo mejorado -->
            <line 
              *ngIf="getRoomCoords(room).x === 60" 
              [attr.x1]="getRoomCoords(room).x"
              [attr.y1]="getRoomCenter(room).y - 20"
              [attr.x2]="getRoomCoords(room).x"
              [attr.y2]="getRoomCenter(room).y + 20"
              stroke="#a1a1aa" 
              stroke-width="3.5"
              stroke-linecap="round">
            </line>
            
            <line 
              *ngIf="getRoomCoords(room).x + getRoomCoords(room).width >= 940" 
              [attr.x1]="getRoomCoords(room).x + getRoomCoords(room).width"
              [attr.y1]="getRoomCenter(room).y - 20"
              [attr.x2]="getRoomCoords(room).x + getRoomCoords(room).width"
              [attr.y2]="getRoomCenter(room).y + 20"
              stroke="#a1a1aa" 
              stroke-width="3.5"
              stroke-linecap="round">
            </line>
            
            <line 
              *ngIf="getRoomCoords(room).y === 60" 
              [attr.x1]="getRoomCenter(room).x - 20"
              [attr.y1]="getRoomCoords(room).y"
              [attr.x2]="getRoomCenter(room).x + 20"
              [attr.y2]="getRoomCoords(room).y"
              stroke="#a1a1aa" 
              stroke-width="3.5"
              stroke-linecap="round">
            </line>
          </ng-container>
          
          <!-- Entrada principal con puerta mejorada -->
          <rect x="10" y="160" width="40" height="30" fill="#bfdbfe" stroke="#3b82f6" stroke-width="2" rx="3" ry="3" filter="url(#dropShadow)"></rect>
          <path d="M 50,160 A 30,30 0 0 1 50,190" fill="none" stroke="#3b82f6" stroke-width="2"></path>
          <text x="30" y="178" text-anchor="middle" class="text-xs font-bold" fill="#1e40af">ENTRADA</text>
          
          <!-- Rosa de los vientos mejorada y más compacta
          <g transform="translate(925, 75)">
            <circle cx="0" cy="0" r="25" fill="white" stroke="#94a3b8" stroke-width="1" filter="url(#dropShadow)"></circle>
            <circle cx="0" cy="0" r="20" fill="white" stroke="#94a3b8" stroke-width="0.5"></circle>
            
            <line x1="0" y1="-20" x2="0" y2="20" stroke="#94a3b8" stroke-width="0.5"></line>
            <line x1="-20" y1="0" x2="20" y2="0" stroke="#94a3b8" stroke-width="0.5"></line>
            
            <path d="M0,0 L0,-16" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowhead)"></path>
            
            <text x="0" y="-10" text-anchor="middle" class="text-xs font-bold" fill="#1e3a8a">N</text>
            <text x="0" y="13" text-anchor="middle" class="text-xs font-bold" fill="#64748b">S</text>
            <text x="-10" y="4" text-anchor="middle" class="text-xs font-bold" fill="#64748b">O</text>
            <text x="10" y="4" text-anchor="middle" class="text-xs font-bold" fill="#64748b">E</text>
          </g> -->
        </g>
      </svg>
      
      <!-- Touch gesture hint overlay (mobile only) -->
      <div class="absolute bottom-2 right-2 flex items-center bg-white/80 backdrop-blur-sm p-1 rounded-md border border-gray-200 shadow-sm text-xs text-gray-600 gap-1 md:hidden">
        <i class="fa-solid fa-hand-pointer text-gray-500"></i>
        <span>Toque para ver detalles</span>
      </div>
    </div>
    
    <!-- Información adicional y leyenda para móviles -->
    <div class="mt-2 text-xs text-gray-500 hidden xs:block sm:hidden">
      <p>Toque las habitaciones para ver detalles. Use los controles para ajustar la vista.</p>
    </div>
  </div>
</div>